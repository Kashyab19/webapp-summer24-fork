name: Build, Test, and Deploy on PR Merge

on:
  pull_request:
    branches:
      - main
      - master # Adjust based on your target branch for merges

jobs:
  integration-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # Integration testing steps
      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          sudo -u postgres psql -c "CREATE USER ${{ secrets.POSTGRES_USER }} WITH ENCRYPTED PASSWORD '${{ secrets.POSTGRES_PASSWORD }}';"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE postgres TO ${{ secrets.POSTGRES_USER }};"

      - name: Configure PostgreSQL (Enable uuid-ossp)
        run: |
          sudo -u postgres psql -d postgres -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.21.6'

      - name: Cache Go Modules
        uses: actions/cache@v2
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-build-${{ hashFiles('**/go.sum') }}

      - name: Install Dependencies
        run: go mod tidy

      - name: Build Project
        run: go build -v ./...

      - name: Run Tests Run Test
        run: go test -v ./...
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432

      - name: Build application artifact
        run: go build -o ./bin/webapp

      # Set up Packer (specify the version that matches your requirements)
      - name: Set up Packer
        uses: hashicorp/setup-packer@main
        with:
          packer-version: '1.10.1'

      - name: Initialize Packer
        run: packer init .

      # Prepare GCP credentials for Packer
      - name: Set up GCP Credentials for Packer
        run: |
          echo '${{ secrets.GCP_SA_KEY_2 }}' > account-2.json

      # Build the Packer image
      - name: Build Packer image
        run: |
          PACKER_LOG=1 packer build -var-file=variables.pkrvars.hcl new.pkr.hcl
        env:
          PKR_VAR_account_file: ${{ github.workspace }}/account-2.json
